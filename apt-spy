#! /bin/bash
# AOSC apt-spy equiviant. Reads mirror list from http://www.anthonos.org/mirrors.list and performs speed tests.
# apt-spy.conf should be:
# Sources="os2 os2-anthonos" (Something like that)
# Method=[ ping | wget ] (Defines how to perform tests)
# MainURL=http://mirror.anthonos.org/mirrors.list
# # End of apt-spy.conf / DEFAULTCONF.
# -*- vim:fenc=utf-8:shiftwidth=2::softtabstop=2:autoindent

# Copyright (C) 2006-2012 Bart Martens <bartm@knars.be> # I copied die_hard() from update-flashplugin-nonfree...
# Copyright (C) 2014 Arthur Wang <arthur200126@gmail.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.



set -e

return_0() { return 0; }
trap "return_0" 0

die_hard() {
  echo -e "ERROR: $1" >&2
  echo "More information might be available at:" >&2
  echo "  https://github.com/...../wiki" >&2
  exit 1
}

[ `whoami` = "root" ] || die_hard "must be root (or hack the script)"

show_usage() {
  echo "Usage:"
  echo "  apt-spy --update"
  echo "  apt-spy --restore"
  echo "Additional options:"
  echo "  --verbose"
  echo "  --quiet"
  echo "  --ping"
  echo "  --wget"
  exit 1
}

testping() {

}

testwget() {

}

savesuccess() {
  for site in $TESTEDMIRRORS
  do
    for repo in $Sources 
    do
      
    done
  done
}

commentfail() {
  for f_site in $FAILEDMIRRORS
  do
    for f_repo in $Sources
    do
      # Printf some comments here
    done
  done
}
   getopt_temp=`getopt -o iusfvq --long update,backup,ping,wget,verbose,quiet -n 'apt-spy' -- "$@"` || show_usage
eval set -- "$getopt_temp" || show_usage

Sources="os2 os2-anthonos"
Method=ping
MainURL=http://mirror.anthonos.org/mirrors.list

if [ -r /etc/apt/apt-spy.conf]; then . /etc/apt/apt-spy.conf; else echo -e "Sources=$Sources\nMethod=$Method\nMainURL=$MainURL" > /etc/apt-spy.conf; echo "Config not found. Writing Defaults."; fi

while [ true ]
do
  case "$1" in
    -u|--update)
      ACTION="update"
      shift
      ;;
    -r|--restore)
      ACTION="restore"
      shift
      ;;
    -p|--ping)
      Method=ping
      shift
      ;;
    -w|--wget)
      Method=wget
      shift
      ;;
    -v|--verbose)
      verbose=yes
      shift
      ;;
    -q|--quiet)
      quiet=yes
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "Internal error!"
      exit 1
      ;;
    esac
done
[ "$ACTION" != "none" -a $# -eq 0 ] || show_usage
[ "$ACTION" != "none" -a $# -eq 0 ] || show_usage
[ "$verbose" != "yes" ] || echo "options : $getopt_temp"

case "$ACTION" in
  update)
    mv /etc/apt/sources.list ~/sources.list.bak # Do a backup
    Mirrors="`wget -nv -O - http://mirror.anthonos.org/mirrors.list`" || ((echo "Trying to use local mirror list" && Mirrors="`cat /etc/apt/mirrors.list`")) || die_hard "AOSC apt-spy can\'t get a mirror list."
    case "$Method" in # Test the speed, returns sorted results in $TESTEDMIRRORS and failed results in $FAILEDMIRRORS
      ping)
        testping
	;;
      wget)
        testwget
        ;;
    esac
    echo "# sources.list genereted by AOSC apt-spy." > /etc/apt/sources.list || die_hard "Cannot write to sources.list, please check permissions:\n`ls -alh /etc/apt`"
    savesuccess
    commentfail
    ;;
  restore)
    mv ~/sources.list.bak /etc/apt/sources.list || die_hard "No backup files found. Make sure sources.list.bak is inside your \$HOME directory."
    ;;
esac
